/**
 * SAMPLE CODE NOTICE
 * 
 * THIS SAMPLE CODE IS MADE AVAILABLE AS IS.  MICROSOFT MAKES NO WARRANTIES, WHETHER EXPRESS OR IMPLIED,
 * OF FITNESS FOR A PARTICULAR PURPOSE, OF ACCURACY OR COMPLETENESS OF RESPONSES, OF RESULTS, OR CONDITIONS OF MERCHANTABILITY.
 * THE ENTIRE RISK OF THE USE OR THE RESULTS FROM THE USE OF THIS SAMPLE CODE REMAINS WITH THE USER.
 * NO TECHNICAL SUPPORT IS PROVIDED.  YOU MAY NOT DISTRIBUTE THIS CODE UNLESS YOU HAVE A LICENSE AGREEMENT WITH MICROSOFT THAT ALLOWS YOU TO DO SO.
 */
 
-- Create the custom extension view that is accessed by CRT to query the custom fields.
GO
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON 
GO

IF (SELECT OBJECT_ID('[ext].[CFZINVENTTABLEVIEW]')) IS NOT NULL
    DROP VIEW [ext].[CFZINVENTTABLEVIEW]
GO

CREATE VIEW [ext].[CFZINVENTTABLEVIEW] AS
(
	select it.ITEMID itemId , it.NAMEALIAS as ItemName , it.ITEMBUYERGROUPID PCTCode ,it.DATAAREAID  from ax.INVENTTABLE it 
)
GO

GRANT SELECT ON OBJECT::[ext].[CFZINVENTTABLEVIEW] TO [UsersRole];
GO

GRANT SELECT ON OBJECT::[ext].[CFZINVENTTABLEVIEW] TO [DeployExtensibilityRole];
GO

--  CFZRETAILTERMINALTABLEVIEW

GO
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON 
GO
IF (SELECT OBJECT_ID('[ext].[CFZRETAILTERMINALTABLEVIEW]')) IS NOT NULL
    DROP VIEW [ext].[CFZRETAILTERMINALTABLEVIEW]
GO

CREATE VIEW [ext].[CFZRETAILTERMINALTABLEVIEW] AS
(
	select rtt.[LOCATION] , rtt.TERMINALID  from ax.RETAILTERMINALTABLE rtt

 )
GO

GRANT SELECT ON OBJECT::[ext].[CFZRETAILTERMINALTABLEVIEW] TO [UsersRole];
GO

GRANT SELECT ON OBJECT::[ext].[CFZRETAILTERMINALTABLEVIEW] TO [DeployExtensibilityRole];
GO

--  CFZCUSTDISCOUNTUSED

GO
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON 
GO
IF (SELECT OBJECT_ID('[ext].[CFZCUSTDISCOUNTUSED]')) IS NOT NULL
    DROP VIEW [ext].[CFZCUSTDISCOUNTUSED]
GO

CREATE VIEW [ext].[CFZCUSTDISCOUNTUSED] AS
(
	select	rtdtc.AMOUNT,
			rtstc.QTY,
            rtstc.CUSTACCOUNT,
            rtd.TRANSDATE,
            rtd.DATAAREAID,
			rtd.REPLICATIONCOUNTERFROMORIGIN
	from
        ax.RETAILTRANSACTIONDISCOUNTTRANS rtdtc
			inner join ax.retailPeriodicDiscount rpd
                on rpd.OfferId = rtdtc.PeriodicDiscountOfferId
                and rpd.Name = 'Employee Discount'
            inner join ax.RETAILTRANSACTIONSALESTRANS rtstc
                on rtstc.TRANSACTIONID = rtdtc.TRANSACTIONID
                and rtstc.LINENUM = rtdtc.SALELINENUM
                and rtstc.STORE = rtdtc.STOREID
                and rtstc.TERMINALID = rtdtc.TERMINALID
				and rtstc.DATAAREAID = rtdtc.DATAAREAID

            inner join ax.RETAILTRANSACTIONTABLE rtd
                on rtstc.TRANSACTIONID = rtd.TRANSACTIONID
                and rtstc.STORE = rtd.STORE
                and rtstc.TERMINALID = rtd.TERMINAL
                and rtstc.CHANNEL = rtd.CHANNEL
				and rtstc.DATAAREAID = rtd.DATAAREAID
                
			where rtd.TRANSACTIONID is not null
				and rtd.TYPE = 2
				and rtd.TRANSDATE >= getdate()-30
				and (rtd.ENTRYSTATUS= 0 or rtd.ENTRYSTATUS= 2 or rtd.ENTRYSTATUS =3)
				and (rtstc.TRANSACTIONSTATUS = 0 or rtstc.TRANSACTIONSTATUS= 2 or rtstc.TRANSACTIONSTATUS =3)
 )
GO

GRANT SELECT ON OBJECT::[ext].[CFZCUSTDISCOUNTUSED] TO [UsersRole];
GO

GRANT SELECT ON OBJECT::[ext].[CFZCUSTDISCOUNTUSED] TO [DeployExtensibilityRole];
GO


--  CFZCUSTDISCOUNTUSEDMANUAL

GO
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON 
GO
IF (SELECT OBJECT_ID('[ext].[CFZCUSTDISCOUNTUSEDMANUAL]')) IS NOT NULL
    DROP VIEW [ext].[CFZCUSTDISCOUNTUSEDMANUAL]
GO

CREATE VIEW [ext].[CFZCUSTDISCOUNTUSEDMANUAL] AS
(
	select	rtdtc.AMOUNT,
			rtstc.QTY,
            rtstc.CUSTACCOUNT,
            rtd.TRANSDATE,
            rtd.DATAAREAID,
			rtd.REPLICATIONCOUNTERFROMORIGIN,
			rtdtc.MANUALDISCOUNTTYPE
	from
        ax.RETAILTRANSACTIONDISCOUNTTRANS rtdtc
			
            inner join ax.RETAILTRANSACTIONSALESTRANS rtstc
                on rtstc.TRANSACTIONID = rtdtc.TRANSACTIONID
                and rtstc.LINENUM = rtdtc.SALELINENUM
                and rtstc.STORE = rtdtc.STOREID
                and rtstc.TERMINALID = rtdtc.TERMINALID
				and rtstc.DATAAREAID = rtdtc.DATAAREAID

            inner join ax.RETAILTRANSACTIONTABLE rtd
                on rtstc.TRANSACTIONID = rtd.TRANSACTIONID
                and rtstc.STORE = rtd.STORE
                and rtstc.TERMINALID = rtd.TERMINAL
                and rtstc.CHANNEL = rtd.CHANNEL
				and rtstc.DATAAREAID = rtd.DATAAREAID
            
			Inner Join ax.RETAILCUSTAFFILIATION rca
				on rca.CUSTACCOUNTNUM=rtd.CUSTACCOUNT


			where rtd.TRANSACTIONID is not null
				and rtd.TYPE = 2
				and rtd.TRANSDATE >= getdate()-30
				and (rtd.ENTRYSTATUS= 0 or rtd.ENTRYSTATUS= 2 or rtd.ENTRYSTATUS =3)
				and (rtstc.TRANSACTIONSTATUS = 0 or rtstc.TRANSACTIONSTATUS= 2 or rtstc.TRANSACTIONSTATUS =3)
				and rtdtc.MANUALDISCOUNTTYPE = 3
				and rtdtc.PeriodicDiscountOfferId not in (select rpd.OfferId from ax.retailPeriodicDiscount rpd
                where rpd.Name = 'Employee Discount')
 )
GO

GRANT SELECT ON OBJECT::[ext].[CFZCUSTDISCOUNTUSEDMANUAL] TO [UsersRole];
GO

GRANT SELECT ON OBJECT::[ext].[CFZCUSTDISCOUNTUSEDMANUAL] TO [DeployExtensibilityRole];
GO


/****** Object:  Table [ext].[CFZFBRResponse]    Script Date: 8/30/2019 7:45:12 AM ******/

GO
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


IF (SELECT OBJECT_ID('[ext].[CFZFBRResponse]')) IS NULL 
BEGIN

CREATE TABLE [ext].[CFZFBRResponse](
	[TRANSACTIONID] [nvarchar](44) NOT NULL,
	[ISHQ] [int] NOT NULL  DEFAULT 1,
	[FBRID] [nvarchar](100) NULL,
	[custCNIC] [nvarchar](30) NULL,
	[REPLICATIONCOUNTERFROMORIGIN] [int] IDENTITY(1,1) NOT NULL,
	[ROWVERSION] [timestamp] NOT NULL,
	[DATAAREAID] [nvarchar](4) NOT NULL DEFAULT ('') ,
 CONSTRAINT [PK_CFZFBRResponse] PRIMARY KEY CLUSTERED 
(
	[TRANSACTIONID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

END

GRANT SELECT, INSERT, UPDATE, DELETE, ALTER ON OBJECT::[ext].[CFZFBRResponse] TO [DataSyncUsersRole];
GO
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER ON OBJECT::[ext].[CFZFBRResponse] TO [UsersRole];
GO
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER ON OBJECT::[ext].[CFZFBRResponse] TO [DeployExtensibilityRole];
GO


/****** Object:  Table [dbo].[CFZFBRMPOSTRANSDATALOGS]    Script Date: 10/30/2019 2:53:29 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
IF (SELECT OBJECT_ID('[ext].[CFZFBRMPOSTRANSDATALOGS]')) IS NULL 
BEGIN

CREATE TABLE [ext].[CFZFBRMPOSTRANSDATALOGS](
	[TRANSACTIONID] [nvarchar](44) NOT NULL,
	[TransJson] [nvarchar](max) NULL,
	[TERMINALID] [nvarchar](100) NOT NULL,
	[POSID] [nvarchar](10) NOT NULL,
	[ResponseJson] [nvarchar](1000) NOT NULL,
    [REPLICATIONCOUNTERFROMORIGIN] [int] IDENTITY(1,1) NOT NULL,
	[ROWVERSION] [timestamp] NOT NULL,
	[DATAAREAID] [nvarchar](4) NOT NULL
	 CONSTRAINT [I_CFZFBRMPOSTRANSDATALOGS] PRIMARY KEY CLUSTERED  
	(
		[TRANSACTIONID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

 END
GO
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZFBRMPOSTRANSDATALOGS] TO [DataSyncUsersRole];
GO
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZFBRMPOSTRANSDATALOGS] TO [UsersRole];
GO
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZFBRMPOSTRANSDATALOGS] TO [DeployExtensibilityRole];
GO


/****** Object:  Table [dbo].[CFZFBRAPIURL]    Script Date: 6/16/2020 7:26:01 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

IF (SELECT OBJECT_ID('[ext].[CFZFBRAPIURL]')) IS NULL 
BEGIN

CREATE TABLE [ext].[CFZFBRAPIURL](
	[CFZFBRAPI] [nvarchar](200) NOT NULL,
	[CFZFBRAPITOKEN] [nvarchar](200) NOT NULL,
	[CFZFBRAPITYPE] [int] NOT NULL,
	[DATAAREAID] [nvarchar](4) NOT NULL,
	[ROWVERSION] [timestamp] NOT NULL
 CONSTRAINT [I_8164_CFZFBRAPIURL] PRIMARY KEY CLUSTERED 
(
	[DATAAREAID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] 

END
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZFBRAPIURL] TO [DataSyncUsersRole];
GO
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZFBRAPIURL] TO [UsersRole];
GO
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZFBRAPIURL] TO [DeployExtensibilityRole];
GO

--  CFZRETAILINCOMEEXPENSEACCOUNTTABLEVIEW

GO
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON 
GO
IF (SELECT OBJECT_ID('[ext].[CFZRETAILINCOMEEXPENSEACCOUNTTABLEVIEW]')) IS NOT NULL
    DROP VIEW [ext].[CFZRETAILINCOMEEXPENSEACCOUNTTABLEVIEW]
GO

CREATE VIEW [ext].[CFZRETAILINCOMEEXPENSEACCOUNTTABLEVIEW] AS
(
	select rieat.[MESSAGELINE1],rieat.[MESSAGELINE2],rieat.[SLIPTEXT1],rieat.[SLIPTEXT2],rieat.[STOREID],rieat.[ACCOUNTNUM],rieat.[DATAAREAID] from ax.RETAILINCOMEEXPENSEACCOUNTTABLE rieat

 )
GO

GRANT SELECT ON OBJECT::[ext].[CFZRETAILINCOMEEXPENSEACCOUNTTABLEVIEW] TO [UsersRole];
GO

GRANT SELECT ON OBJECT::[ext].[CFZRETAILINCOMEEXPENSEACCOUNTTABLEVIEW] TO [DeployExtensibilityRole];
GO

/****** Object:  Table [dbo].[CFZSMSMESSAGE]    Script Date: 10/30/2019 2:53:29 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
IF (SELECT OBJECT_ID('[ext].[CFZSMSMESSAGE]'))  IS NOT NULL 
BEGIN
DROP TABLE [ext].[CFZSMSMESSAGE]
END

BEGIN
CREATE TABLE [ext].[CFZSMSMESSAGE](
	[ID] [int] NOT NULL,
	[MESSAGE] [nvarchar](max) NOT NULL,
	[TYPE] [int] NOT NULL,
	[DATAAREAID] [nvarchar](4) NOT NULL,
	[ROWVERSION] [timestamp] NOT NULL,
	[RECID] [bigint] NOT NULL,
	CONSTRAINT [I_CFZSMSMESSAGE_1429128816] PRIMARY KEY CLUSTERED 
(
	[RECID] ASC,
	[DATAAREAID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY],
 CONSTRAINT [I_CFZSMSMESSAGE_474954108] UNIQUE NONCLUSTERED 
(
	[ID] ASC,
	[RECID] ASC,
	[DATAAREAID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
 ) ON [PRIMARY]
 
END
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZSMSMESSAGE] TO [DataSyncUsersRole];
GO
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZSMSMESSAGE] TO [UsersRole];
GO
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZSMSMESSAGE] TO [DeployExtensibilityRole];
GO

/****** Object:  Table [dbo].[CFZSMSSETTING]    Script Date: 10/30/2019 2:53:29 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
IF (SELECT OBJECT_ID('[ext].[CFZSMSSETTING]')) IS NOT NULL 
BEGIN
DROP TABLE [ext].[CFZSMSSETTING]
END

BEGIN
CREATE TABLE [ext].[CFZSMSSETTING](
	[USERNAME] [nvarchar](60) NOT NULL,
	[PASSWORD] [nvarchar](255) NOT NULL,
	[MASK] [nvarchar](50) NOT NULL,
	[API] [nvarchar](255) NOT NULL,
	[DATAAREAID] [nvarchar](4) NOT NULL,
	[ROWVERSION] [timestamp] NOT NULL,
	[RECID] [bigint] NOT NULL,
	CONSTRAINT [I_CFZSMSSETTING_1429128816] PRIMARY KEY CLUSTERED 
(
	[RECID] ASC,
	[DATAAREAID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY],
 CONSTRAINT [I_CFZSMSSETTING_474954108] UNIQUE NONCLUSTERED 
(
	[RECID] ASC,
	[DATAAREAID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
 ) ON [PRIMARY]
 
END
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZSMSSETTING] TO [DataSyncUsersRole];
GO
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZSMSSETTING] TO [UsersRole];
GO
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZSMSSETTING] TO [DeployExtensibilityRole];
GO


/****** Object:  Table [dbo].[CFZSMSLOGHISTORY]    Script Date: 10/30/2019 2:53:29 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
IF (SELECT OBJECT_ID('[ext].[CFZSMSLOGHISTORY]')) IS NULL 
BEGIN

CREATE TABLE [ext].[CFZSMSLOGHISTORY](
	[ID] [nvarchar](30) NOT NULL,
	[RESPONSE] [nvarchar](50) NOT NULL,
	[TYPE] [int] NOT NULL,
	[MESSAGE] [nvarchar](500) NOT NULL,
	[DATAAREAID] [nvarchar](4) NOT NULL DEFAULT (''),
	[REPLICATIONCOUNTERFROMORIGIN] [int] IDENTITY(1,1) NOT NULL,
	[ROWVERSION] [timestamp] NOT NULL,
	CONSTRAINT [I_CFZSMSLOGHISTORY_1429128816] PRIMARY KEY CLUSTERED 
(
	[ID] ASC,
	[TYPE] ASC,
	[DATAAREAID] ASC
 )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
 ) ON [PRIMARY]
 
END
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZSMSLOGHISTORY] TO [DataSyncUsersRole];
GO
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZSMSLOGHISTORY] TO [UsersRole];
GO
GRANT SELECT, INSERT, UPDATE, DELETE, ALTER  ON OBJECT::[ext].[CFZSMSLOGHISTORY] TO [DeployExtensibilityRole];
GO

-- Create the custom extension view that is accessed by CRT to query the custom fields.
GO
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON 
GO

IF (SELECT OBJECT_ID('[ext].[CFZPRODUCTCATEGORYVIEW]')) IS NOT NULL
    DROP VIEW [ext].CFZPRODUCTCATEGORYVIEW
GO

CREATE VIEW [ext].CFZPRODUCTCATEGORYVIEW AS
(
	select it.ItemID as ItemID, erph.NAME as Hierarchy, erc4.NAME as CATEGORY,rp.DATAAREAID as DATAAREAID From ax.InventTable it
	join ax.ECORESPRODUCTCATEGORY erpc on erpc.PRODUCT = it.PRODUCT
	join ax.ECORESCATEGORYHIERARCHY erph on erph.RECID = erpc.CATEGORYHIERARCHY
	join ax.ECORESCATEGORY erc4 on erc4.CATEGORYHIERARCHY = erph.RECID and erc4.RECID = erpc.CATEGORY
	join ax.RETAILPARAMETERS rp on rp.DATAAREAID =it.DATAAREAID
)
GO

GRANT SELECT ON OBJECT::[ext].CFZPRODUCTCATEGORYVIEW TO [UsersRole];
GO

GRANT SELECT ON OBJECT::[ext].CFZPRODUCTCATEGORYVIEW TO [DeployExtensibilityRole];
GO